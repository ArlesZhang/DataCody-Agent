
# Docker éƒ¨ç½²æ·±åº¦æŒæ¡æŒ‡å—

## ç›®å½•
1. [Docker æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
2. [ç¯å¢ƒå‡†å¤‡ä¸å®‰è£…](#ç¯å¢ƒå‡†å¤‡) 
3. [Dockerfile æ·±åº¦æŒæ¡](#dockerfileæ·±åº¦)
4. [å®¹å™¨ç½‘ç»œæ·±åº¦è§£æ](#å®¹å™¨ç½‘ç»œ)
5. [å­˜å‚¨ä¸æ•°æ®ç®¡ç†](#å­˜å‚¨ç®¡ç†)
6. [æ—¥å¿—ä¸ç›‘æ§](#æ—¥å¿—ç›‘æ§)
7. [Docker Compose å®æˆ˜](#composeå®æˆ˜)
8. [ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ](#ç”Ÿäº§å®è·µ)
9. [DataCody Agent éƒ¨ç½²æ¡ˆä¾‹](#datacodyæ¡ˆä¾‹)
10. [å­¦ä¹ èµ„æº](#å­¦ä¹ èµ„æº) 

---

## æ ¸å¿ƒæ¦‚å¿µ

### Docker åŸºç¡€çŸ¥è¯†

**æ–‡å­—è§£é‡Š**ï¼šDocker æ˜¯ä¸€ç§å®¹å™¨åŒ–å¹³å°ï¼Œç”¨äºæ‰“åŒ…åº”ç”¨åŠå…¶ä¾èµ–ï¼Œç¡®ä¿åœ¨ä»»ä½•ç¯å¢ƒä¸­ä¸€è‡´è¿è¡Œã€‚å®ƒè§£å†³äº†â€œåœ¨æˆ‘çš„æœºå™¨ä¸Šèƒ½è·‘ï¼Œä¸ºä»€ä¹ˆéƒ¨ç½²å¤±è´¥ï¼Ÿâ€çš„é—®é¢˜ã€‚åœ¨ DevOps ä¸­ï¼ŒDocker æ˜¯ CI/CD ç®¡é“çš„åŸºç¡€ï¼›åœ¨ä½ çš„ DataCody é¡¹ç›®ä¸­ï¼Œå®ƒå¯ä»¥å®¹å™¨åŒ–æ•°æ®å·¥ä½œæµç¼–è¯‘å™¨ï¼Œé¿å…ç¯å¢ƒå·®å¼‚å¯¼è‡´çš„ bugã€‚

âœ… DevOps = Development + Operations                         
âœ… CI â€” Continuous Integrationï¼ˆæŒç»­é›†æˆï¼‰                                   
âœ…CD â€” Continuous Delivery / Continuous Deploymentï¼ˆæŒç»­äº¤ä»˜/éƒ¨ç½²ï¼‰
### Docker æ¶æ„ç»„ä»¶

| ç»„ä»¶                    | è¯´æ˜                            | ç±»æ¯”     | ç¤ºä¾‹å‘½ä»¤/ç”¨é€”                    |
| --------------------- | ----------------------------- | ------ | -------------------------- |
| Docker Image(é•œåƒ )     | åªè¯»æ¨¡æ¿ï¼ŒåŒ…å«åº”ç”¨å’Œç¯å¢ƒã€‚åƒè½¯ä»¶çš„â€œå®‰è£…åŒ…â€ã€‚       | è½¯ä»¶å®‰è£…åŒ…  | docker pull nginx          |
| Docker Container(å®¹å™¨ ) | é•œåƒçš„è¿è¡Œå®ä¾‹ï¼Œè½»é‡çº§ã€å¯éš”ç¦»çš„è¿›ç¨‹ã€‚åƒâ€œè¿è¡Œä¸­çš„è½¯ä»¶â€ã€‚ | è¿è¡Œçš„è¿›ç¨‹  | docker run -d nginx        |
| Docker Registry(ä»“åº“ )  | é•œåƒä»“åº“ï¼ˆDocker Hubç­‰ï¼‰,å­˜å‚¨é•œåƒçš„åœ°æ–¹     | åº”ç”¨å•†åº—   | docker push myimage:latest |
| Dockerfile            | æ„å»ºé•œåƒçš„è“å›¾æ–‡ä»¶ã€‚                    |        | è§ä»£ç ç¤ºä¾‹                      |
| Docker Daemon         | åå°æœåŠ¡è¿›ç¨‹ï¼Œç®¡ç†å®¹å™¨                   | æ“ä½œç³»ç»Ÿå†…æ ¸ |                            |
| Docker Client         | å‘½ä»¤è¡Œå·¥å…·ï¼Œä¸Daemonäº¤äº’               | ç»ˆç«¯/å‘½ä»¤è¡Œ |                            |

æ•´ä¸ªæµç¨‹å›¾
```text
åŸºç¡€é•œåƒ 
   â†“ï¼ˆ+ Dockerfile å±‚å±‚æ·»åŠ ï¼‰
å®Œæ•´é•œåƒ â†’ ä¸Šä¼ åˆ° Registryï¼ˆDocker Hubï¼‰
   â†“ï¼ˆdocker runï¼‰
å®¹å™¨ï¼ˆä¸´æ—¶æˆ–é•¿æœŸè¿è¡Œï¼‰
   â†“ï¼ˆç”¨å®Œå°±åˆ æˆ–ç»§ç»­è·‘ï¼‰
å¹²å‡€ã€å¿«é€Ÿã€å¯é‡å¤ï¼
```

Dockerfileæ„å»ºé•œåƒçš„è“å›¾æ–‡ä»¶:
```bash
# æ‹‰å–é•œåƒ
docker pull hello-world

# è¿è¡Œå®¹å™¨ï¼ˆ-it: äº¤äº’æ¨¡å¼ï¼‰
docker run -it hello-world

# æŸ¥çœ‹è¿è¡Œä¸­å®¹å™¨
docker ps

# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨ï¼ˆåŒ…æ‹¬åœæ­¢çš„ï¼‰
docker ps -a
```

### æ ¸å¿ƒæ¦‚å¿µå…³ç³»å›¾
```
Dockerfile â†’ Build â†’ Image â†’ Run â†’ Container
    â†‘                           â†“
Registry â† Push/Pull â†       Logs/Metrics
```

---

## ç¯å¢ƒå‡†å¤‡

### ç³»ç»Ÿè¦æ±‚ä¸å®‰è£…

#### Linux ç³»ç»Ÿå®‰è£…
```bash
# ä½¿ç”¨å®˜æ–¹å®‰è£…è„šæœ¬
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# æ·»åŠ ç”¨æˆ·åˆ° docker ç»„
sudo usermod -aG docker $USER

# é‡å¯ docker æœåŠ¡
sudo systemctl enable docker
sudo systemctl start docker
```

#### Windows/Mac
- ä¸‹è½½ Docker Desktop
- å¯ç”¨ WSL2 (Windows)
- é…ç½®èµ„æºé™åˆ¶ï¼ˆCPU/å†…å­˜ï¼‰

### éªŒè¯å®‰è£…
```bash
# æ£€æŸ¥ç‰ˆæœ¬
docker --version
docker-compose --version

# è¿è¡Œæµ‹è¯•å®¹å™¨
docker run hello-world

# æŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯
docker system info
```

---

## Dockerfile æ·±åº¦æŒæ¡

### Dockerfile æŒ‡ä»¤è¯¦è§£

| æŒ‡ä»¤ | ä½œç”¨ | æœ€ä½³å®è·µ |
|------|------|----------|
| FROM | åŸºç¡€é•œåƒ | ä½¿ç”¨å®˜æ–¹é•œåƒï¼ŒæŒ‡å®šç‰ˆæœ¬ |
| RUN | æ‰§è¡Œå‘½ä»¤ | åˆå¹¶å‘½ä»¤ï¼Œæ¸…ç†ç¼“å­˜ |
| COPY | å¤åˆ¶æ–‡ä»¶ | æ˜ç¡®æºå’Œç›®æ ‡è·¯å¾„ |
| ADD | å¤åˆ¶+è§£å‹ | ä»…ç”¨äºtarè‡ªåŠ¨è§£å‹ |
| ENV | ç¯å¢ƒå˜é‡ | é›†ä¸­å£°æ˜ï¼Œåˆç†å‘½å |
| WORKDIR | å·¥ä½œç›®å½• | ç»å¯¹è·¯å¾„ï¼Œé¿å…å¤šå±‚ |
| EXPOSE | æš´éœ²ç«¯å£ | æ–‡æ¡£åŒ–ç«¯å£ç”¨é€” |
| CMD | é»˜è®¤å‘½ä»¤ | ä½¿ç”¨æ•°ç»„æ ¼å¼ |
| ENTRYPOINT | å…¥å£ç‚¹ | ä¸CMDé…åˆä½¿ç”¨ |

### ä¼˜åŒ–åçš„ Dockerfile ç¤ºä¾‹
```dockerfile
# å¤šé˜¶æ®µæ„å»ºç¤ºä¾‹ - Python åº”ç”¨
FROM python:3.9-slim as builder

# å®‰è£…æ„å»ºä¾èµ–
RUN apt-get update && apt-get install -y \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# å®‰è£…ä¾èµ–
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# è¿è¡Œæ—¶é˜¶æ®µ
FROM python:3.9-slim

# å®‰è£…è¿è¡Œæ—¶ä¾èµ–
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶è™šæ‹Ÿç¯å¢ƒ
COPY --from=builder /opt/venv /opt/venv

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PATH="/opt/venv/bin:$PATH" \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1

# åˆ›å»ºérootç”¨æˆ·
RUN groupadd -r appuser && useradd -r -g appuser appuser

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY --chown=appuser:appuser . .

# åˆ‡æ¢ç”¨æˆ·
USER appuser

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# å¯åŠ¨å‘½ä»¤
CMD ["gunicorn", "app:app", "--bind", "0.0.0.0:8000"]
```

### æ„å»ºä¼˜åŒ–æŠ€å·§
```bash
# ä½¿ç”¨ .dockerignore æ–‡ä»¶
echo "**/__pycache__
*.pyc
.git
.env
.DS_Store
README.md" > .dockerignore

# æ„å»ºç¼“å­˜ä¼˜åŒ–
docker build -t myapp:latest .

# å¤šé˜¶æ®µæ„å»ºæ¸…ç†
docker system prune -f
```

---

## å®¹å™¨ç½‘ç»œæ·±åº¦è§£æ

### ç½‘ç»œé©±åŠ¨æ¯”è¾ƒ

| ç½‘ç»œç±»å‹ | é€‚ç”¨åœºæ™¯ | ç‰¹ç‚¹ | æ€§èƒ½ |
|----------|----------|------|------|
| bridge | å•æœºå®¹å™¨é€šä¿¡ | é»˜è®¤ç½‘ç»œï¼ŒNAT | ä¸­ç­‰ |
| host | é«˜æ€§èƒ½éœ€æ±‚ | ç›´æ¥ä½¿ç”¨ä¸»æœºç½‘ç»œ | æœ€é«˜ |
| overlay | é›†ç¾¤å®¹å™¨é€šä¿¡ | Swarm/K8sè·¨èŠ‚ç‚¹ | ä¸­ç­‰ |
| macvlan | ç‰©ç†ç½‘ç»œé›†æˆ | ç›´æ¥åˆ†é…MACåœ°å€ | é«˜ |
| none | å®Œå…¨éš”ç¦» | æ— ç½‘ç»œæ¥å£ | - |

### ç½‘ç»œè¯Šæ–­å‘½ä»¤é›†
```bash
# æŸ¥çœ‹ç½‘ç»œé…ç½®
docker network ls
docker network inspect bridge

# åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œ
docker network create --driver bridge \
    --subnet=172.20.0.0/16 \
    --gateway=172.20.0.1 \
    my-network

# å®¹å™¨ç½‘ç»œè¿æ¥
docker run -d --name web --network my-network nginx
docker run -it --network my-network --rm alpine ping web

# ç½‘ç»œè¯Šæ–­å·¥å…·
docker exec -it web ip addr show
docker exec -it web cat /etc/hosts
docker exec -it web netstat -tulpn
```

### å¤æ‚ç½‘ç»œåœºæ™¯ç¤ºä¾‹
```yaml
# docker-compose-network.yml
version: '3.8'
services:
  web:
    image: nginx:alpine
    networks:
      frontend:
        ipv4_address: 172.20.0.10
      backend:
        ipv4_address: 172.21.0.10
    
  api:
    image: node:14
    networks:
      backend:
        ipv4_address: 172.21.0.20
      
  database:
    image: postgres:13
    networks:
      database:
        ipv4_address: 172.22.0.10

networks:
  frontend:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
  backend:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/24
  database:
    driver: bridge
    ipam:
      config:
        - subnet: 172.22.0.0/24
```

---

## å­˜å‚¨ä¸æ•°æ®ç®¡ç†

### å­˜å‚¨é©±åŠ¨å¯¹æ¯”

| å­˜å‚¨é©±åŠ¨ | é€‚ç”¨åœºæ™¯ | æ€§èƒ½ | ç¨³å®šæ€§ |
|----------|----------|------|---------|
| overlay2 | ç”Ÿäº§ç¯å¢ƒæ¨è | é«˜ | é«˜ |
| aufs | æ—§ç‰ˆæœ¬å…¼å®¹ | ä¸­ | ä¸­ |
| devicemapper | ä¼ä¸šå­˜å‚¨ | é«˜ | ä¸­ |
| btrfs | å¼€å‘æµ‹è¯• | ä¸­ | ä½ |

### æ•°æ®æŒä¹…åŒ–ç­–ç•¥

```bash
# 1. ç»‘å®šæŒ‚è½½ (å¼€å‘ç¯å¢ƒ)
docker run -v /host/path:/container/path nginx

# 2. æ•°æ®å· (ç”Ÿäº§ç¯å¢ƒ)
docker volume create mydata
docker run -v mydata:/app/data nginx

# 3. ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿ
docker run --tmpfs /app/cache nginx

# 4. å‘½åç®¡é“
mkfifo /host/fifo
docker run -v /host/fifo:/container/fifo app
```

### æ•°æ®å·ç®¡ç†å‘½ä»¤
```bash
# å·ç®¡ç†
docker volume create app_data
docker volume ls
docker volume inspect app_data
docker volume rm app_data

# å¤‡ä»½ä¸æ¢å¤
docker run --rm -v app_data:/source -v $(pwd):/backup alpine \
    tar czf /backup/backup.tar.gz -C /source .

docker run --rm -v app_data:/target -v $(pwd):/backup alpine \
    tar xzf /backup/backup.tar.gz -C /target
```

---

## æ—¥å¿—ä¸ç›‘æ§

### æ—¥å¿—é©±åŠ¨é…ç½®

| æ—¥å¿—é©±åŠ¨ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|----------|------|----------|
| json-file | é»˜è®¤é©±åŠ¨ï¼Œç»“æ„åŒ–æ—¥å¿— | å¼€å‘ç¯å¢ƒ |
| journald | ç³»ç»Ÿæ—¥å¿—é›†æˆ | Systemdç¯å¢ƒ |
| syslog | è¿œç¨‹æ—¥å¿—æ”¶é›† | é›†ä¸­æ—¥å¿—ç®¡ç† |
| gelf | Graylogæ ¼å¼ | å¾®æœåŠ¡æ¶æ„ |
| awslogs | AWS CloudWatch | AWSç¯å¢ƒ |

### æ—¥å¿—é…ç½®ç¤ºä¾‹
```bash
# è¿è¡Œæ—¶æ—¥å¿—é…ç½®
docker run --log-driver=json-file \
    --log-opt max-size=10m \
    --log-opt max-file=3 \
    nginx

# syslog é©±åŠ¨
docker run --log-driver=syslog \
    --log-opt syslog-address=udp://logsrv:514 \
    --log-opt tag="myapp" \
    nginx
```

### å®¹å™¨ç›‘æ§ä½“ç³»
```bash
# å®æ—¶ç›‘æ§
docker stats container_name
docker top container_name

# èµ„æºä½¿ç”¨è¯¦æƒ…
docker container inspect container_name

# æ—¥å¿—æŸ¥çœ‹ä¸è·Ÿè¸ª
docker logs container_name
docker logs -f --tail=100 container_name
docker logs --since="2024-01-01" container_name

# æ€§èƒ½æŒ‡æ ‡å¯¼å‡º
# ä½¿ç”¨ cAdvisor + Prometheus + Grafana
```

### é«˜çº§æ—¥å¿—å¤„ç†è„šæœ¬
```bash
#!/bin/bash
# container-logs-analyzer.sh

CONTAINER_NAME=$1
LOG_FILE="container_${CONTAINER_NAME}_$(date +%Y%m%d).log"

# æ”¶é›†æ—¥å¿—
docker logs --timestamps $CONTAINER_NAME > $LOG_FILE

# åˆ†æé”™è¯¯
echo "=== Error Analysis ==="
grep -i "error\|exception\|failed" $LOG_FILE | head -20

# æ€§èƒ½åˆ†æ
echo "=== Performance Analysis ==="
grep "REQUEST_TIME" $LOG_FILE | awk '{print $NF}' | \
    awk '{sum+=$1; count++} END {print "Avg:", sum/count, "Max:", max}'

# å†…å­˜ä½¿ç”¨è¶‹åŠ¿
docker stats $CONTAINER_NAME --no-stream --format "table {{.MemUsage}}"
```

---

## Docker Compose å®æˆ˜

### å¤šæœåŠ¡ç¼–æ’ç¤ºä¾‹
```yaml
version: '3.8'

services:
  # DataCody Agent æ ¸å¿ƒæœåŠ¡
  datacody-agent:
    build: 
      context: .
      target: production
    image: datacody/agent:latest
    container_name: datacody-agent
    environment:
      - DATABASE_URL=postgresql://user:pass@postgres:5432/datacody
      - REDIS_URL=redis://redis:6379/0
      - LOG_LEVEL=INFO
    volumes:
      - app_data:/app/data
      - ./config:/app/config:ro
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - datacody-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # PostgreSQL æ•°æ®åº“
  postgres:
    image: postgres:13-alpine
    container_name: datacody-postgres
    environment:
      - POSTGRES_DB=datacody
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - datacody-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d datacody"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis ç¼“å­˜
  redis:
    image: redis:6-alpine
    container_name: datacody-redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - datacody-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # ç›‘æ§æœåŠ¡
  prometheus:
    image: prom/prometheus:latest
    container_name: datacody-prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - datacody-network

  # æ—¥å¿—æ”¶é›†
  grafana:
    image: grafana/grafana:latest
    container_name: datacody-grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana
    ports:
      - "3000:3000"
    networks:
      - datacody-network

volumes:
  app_data:
    driver: local
  postgres_data:
    driver: local
  redis_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local

networks:
  datacody-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/24
```

### Compose ç®¡ç†å‘½ä»¤
```bash
# å¯åŠ¨æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f datacody-agent
docker-compose logs --tail=100 datacody-agent

# æœåŠ¡ä¼¸ç¼©
docker-compose up -d --scale datacody-agent=3

# ç¯å¢ƒæ›´æ–°
docker-compose pull
docker-compose up -d

# æ•°æ®å¤‡ä»½
docker-compose exec postgres pg_dump -U user datacody > backup.sql
```

---

## ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ

### å®‰å…¨åŠ å›ºé…ç½®
```dockerfile
# å®‰å…¨åŠ å›ºçš„ Dockerfile
FROM python:3.9-slim

# ä½¿ç”¨érootç”¨æˆ·
RUN groupadd -r appuser && useradd -r -g appuser appuser

# æœ€å°æƒé™åŸåˆ™
WORKDIR /app
COPY --chown=appuser:appuser . .

# å®‰å…¨æ‰«æ
# trivy image your-image:tag

USER appuser

# åªè¯»æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚é€‚ç”¨ï¼‰
# docker run --read-only -v /tmp:/tmp app
```

### èµ„æºé™åˆ¶é…ç½®
```yaml
# docker-compose.prod.yml
services:
  datacody-agent:
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
    restart: unless-stopped
```

### å¥åº·æ£€æŸ¥ç­–ç•¥
```yaml
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 60s
```

---

## DataCody Agent éƒ¨ç½²æ¡ˆä¾‹Gemini

### é¡¹ç›®ç»“æ„
```
datacody-agent/
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ .dockerignore
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ production.yaml
â”‚   â””â”€â”€ logging.conf
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ deploy.sh
â”‚   â””â”€â”€ backup.sh
â””â”€â”€ monitoring/
    â”œâ”€â”€ prometheus.yml
    â””â”€â”€ alerts.yml
```

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è„šæœ¬
```bash
#!/bin/bash
# deploy-prod.sh

set -e

echo "ğŸš€ Starting DataCody Agent Production Deployment"

# ç¯å¢ƒæ£€æŸ¥
if ! command -v docker &> /dev/null; then
    echo "âŒ Docker is not installed"
    exit 1
fi

if ! command -v docker-compose &> /dev/null; then
    echo "âŒ Docker Compose is not installed"
    exit 1
fi

# åˆ›å»ºå¿…è¦ç›®å½•
mkdir -p data/{postgres,redis,logs}
mkdir -p backups

# åŠ è½½ç¯å¢ƒå˜é‡
source .env.production

# åœæ­¢ç°æœ‰æœåŠ¡
echo "ğŸ›‘ Stopping existing services..."
docker-compose down

# æ‹‰å–æœ€æ–°é•œåƒ
echo "ğŸ“¥ Pulling latest images..."
docker-compose pull

# å¯åŠ¨æœåŠ¡
echo "ğŸš€ Starting services..."
docker-compose up -d

# ç­‰å¾…æœåŠ¡å°±ç»ª
echo "â³ Waiting for services to be healthy..."
timeout=300
elapsed=0
while [ $elapsed -lt $timeout ]; do
    if docker-compose ps | grep -q "Up (healthy)"; then
        echo "âœ… All services are healthy!"
        break
    fi
    sleep 10
    elapsed=$((elapsed + 10))
done

if [ $elapsed -ge $timeout ]; then
    echo "âŒ Services failed to become healthy in time"
    docker-compose logs
    exit 1
fi

# è¿è¡Œæ•°æ®åº“è¿ç§»
echo "ğŸ”„ Running database migrations..."
docker-compose exec datacody-agent python manage.py migrate

# å¥åº·æ£€æŸ¥
echo "ğŸ” Performing final health check..."
response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health)
if [ "$response" = "200" ]; then
    echo "ğŸ‰ Deployment completed successfully!"
else
    echo "âŒ Health check failed: HTTP $response"
    exit 1
fi
```

### ç›‘æ§é…ç½®
```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'datacody-agent'
    static_configs:
      - targets: ['datacody-agent:8000']
    metrics_path: '/metrics'
    
  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres:9187']
      
  - job_name: 'redis'
    static_configs:
      - targets: ['redis:9121']
```

---

## DataCody Agent éƒ¨ç½²æ¡ˆä¾‹Grok

### Docker éƒ¨ç½²æ·±åº¦æŒæ¡æŒ‡å—

æ¬¢è¿æ¥åˆ°è¿™ä»½å®Œæ•´çš„ã€ç³»ç»Ÿçš„ã€è¯¦ç»†çš„ã€å¼€ç®±å³ç”¨çš„ Docker éƒ¨ç½²æ·±åº¦æŒæ¡æŒ‡å—ï¼è¿™ä»½æŒ‡å—æ—¨åœ¨å¸®åŠ©ä½ ä» Docker åˆå­¦è€…ï¼ˆå‡è®¾ä½ æœ‰åŸºæœ¬çš„ç¼–ç¨‹èƒŒæ™¯ï¼‰é€æ­¥è¿›é˜¶åˆ°å…·å¤‡ DevOps æ€ç»´çš„é«˜çº§å¼€å‘è€…ã€‚é‡ç‚¹èšç„¦äºå®¹å™¨ç½‘ç»œå’Œæ—¥å¿—è¯Šæ–­ç­‰æ£˜æ‰‹éš¾é¢˜ï¼Œè¿™äº›æ˜¯ Docker é¡¹ç›®ä¸­å¸¸è§çš„ç—›ç‚¹ï¼Œå°¤å…¶åœ¨ä½ çš„ **P2: DataCody Agent - The Data Workflow Compiler for Data Engineers** é¡¹ç›®ä¸­ï¼ŒDocker å¯ä»¥ä½œä¸ºæ•°æ®å·¥ä½œæµç¼–è¯‘å™¨çš„æ ¸å¿ƒå®¹å™¨åŒ–å·¥å…·ï¼Œç¡®ä¿ç¯å¢ƒä¸€è‡´æ€§ã€å¯ç§»æ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚

æŒ‡å—ç»“æ„é‡‡ç”¨**æ¨¡å—åŒ–è®¾è®¡**ï¼šæ¯ä¸ªéƒ¨åˆ†åŒ…æ‹¬**æ–‡å­—è§£é‡Š**ã€**è¡¨æ ¼æ€»ç»“**ã€**ä»£ç ç¤ºä¾‹**ï¼Œå¹¶åœ¨æœ«å°¾æä¾›**å­¦ä¹ èµ„æºé“¾æ¥**ã€‚ä½ å¯ä»¥ä»å¤´åˆ°å°¾æ‰§è¡Œæ¯ä¸ªæ­¥éª¤ï¼ˆå‡è®¾ä½ åœ¨ Linux/Mac/Windows ä¸Šå®‰è£…äº† Dockerï¼‰ã€‚æ•´ä¸ªæŒ‡å—å¼ºè°ƒå®è·µï¼šæ¯æ­¥éƒ½å¯ç«‹å³ä¸Šæ‰‹ã€‚


**å‰æå‡†å¤‡**ï¼š
- å®‰è£… Docker Desktopï¼ˆé€‚ç”¨äºå¼€å‘ï¼‰æˆ– Docker Engineï¼ˆé€‚ç”¨äºç”Ÿäº§ï¼‰ã€‚ä¸‹è½½é“¾æ¥ï¼šhttps://www.docker.com/products/docker-desktop
- æµ‹è¯•å®‰è£…ï¼šè¿è¡Œ `docker --version` å’Œ `docker run hello-world`ã€‚
- ç¯å¢ƒï¼šæ¨è Ubuntu 22.04+ æˆ– macOSï¼Œä¸ºä½ çš„ DataCody é¡¹ç›®å‡†å¤‡ä¸€ä¸ªç®€å• Python åº”ç”¨ä½œä¸ºç¤ºä¾‹ï¼ˆe.g., ä¸€ä¸ª Flask æ•°æ®å¤„ç†æœåŠ¡ï¼‰ã€‚

---

#### æ¨¡å— 1: Docker åŸºç¡€çŸ¥è¯†

Docker æ˜¯ä¸€ç§å®¹å™¨åŒ–å¹³å°ï¼Œç”¨äºæ‰“åŒ…åº”ç”¨åŠå…¶ä¾èµ–ï¼Œç¡®ä¿åœ¨ä»»ä½•ç¯å¢ƒä¸­ä¸€è‡´è¿è¡Œã€‚å®ƒè§£å†³äº†â€œåœ¨æˆ‘çš„æœºå™¨ä¸Šèƒ½è·‘ï¼Œä¸ºä»€ä¹ˆéƒ¨ç½²å¤±è´¥ï¼Ÿâ€çš„é—®é¢˜ã€‚åœ¨ DevOps ä¸­ï¼ŒDocker æ˜¯ CI/CD ç®¡é“çš„åŸºç¡€ï¼›åœ¨ä½ çš„ DataCody é¡¹ç›®ä¸­ï¼Œå®ƒå¯ä»¥å®¹å™¨åŒ–æ•°æ®å·¥ä½œæµç¼–è¯‘å™¨ï¼Œé¿å…ç¯å¢ƒå·®å¼‚å¯¼è‡´çš„ bugã€‚

Dockeré•œåƒçš„æœ¬è´¨æ˜¯ç”±å¤šä¸ªå±‚ï¼ˆLayerï¼‰å †å è€Œæˆçš„ã€‚æ¯ä¸€å±‚è®°å½•äº†ç›¸å¯¹äºä¸Šä¸€å±‚çš„ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿå˜åŒ–ï¼Œè¿™äº›å±‚æ˜¯ä¸å¯å˜çš„ã€åªè¯»çš„ã€‚æƒ³è±¡ä½ æœ‰ä¸€å¼ ç©ºç™½çš„ç…§ç‰‡çº¸ï¼ˆåˆå§‹çŠ¶æ€ï¼‰ï¼Œç„¶åæŒ‰ç…§ä»¥ä¸‹æ­¥éª¤åœ¨ä¸Šé¢æ·»åŠ å†…å®¹ï¼š
1. ç¬¬ä¸€å±‚ï¼šç”»ä¸€ä¸ªæ¡Œå­
2. ç¬¬äºŒå±‚ï¼šåœ¨æ¡Œå­ä¸Šæ”¾ä¸€ä¸ªé”…
3. ç¬¬ä¸‰å±‚ï¼šåœ¨é”…é‡Œæ”¾å…¥æ°´å’Œç±³
4. ç¬¬å››å±‚ï¼šç›–ä¸Šé”…ç›–
æœ€ç»ˆçš„ç…§ç‰‡å°±æ˜¯è¿™å››å±‚å†…å®¹å åŠ çš„ç»“æœã€‚æ¯ä¸€å±‚éƒ½è®°å½•äº†"ç›¸å¯¹äºä¸Šä¸€å±‚çš„å˜åŒ–"ã€‚

DockerfileæŒ‡ä»¤å¦‚ä½•åˆ›å»ºå±‚:
```dockerfile
# è¿™ä¸ªDockerfileæ„å»ºäº†ä¸€ä¸ªå®Œæ•´çš„é•œåƒ 
FROM ubuntu:20.04          # ç¬¬1å±‚ï¼šåŸºç¡€é•œåƒï¼ˆåŒ…å«Ubuntuçš„æ–‡ä»¶ç³»ç»Ÿï¼‰
RUN apt update            # ç¬¬2å±‚ï¼šåœ¨ç¬¬1å±‚åŸºç¡€ä¸Šæ‰§è¡Œapt updateï¼Œè®°å½•æ‰€æœ‰å˜åŒ–çš„æ–‡ä»¶
RUN apt install -y python3  # ç¬¬3å±‚ï¼šåœ¨ç¬¬2å±‚åŸºç¡€ä¸Šå®‰è£…python3ï¼Œè®°å½•æ‰€æœ‰å˜åŒ–çš„æ–‡ä»¶  
COPY app.py /app/        # ç¬¬4å±‚ï¼šåœ¨ç¬¬3å±‚åŸºç¡€ä¸Šå¤åˆ¶app.pyæ–‡ä»¶åˆ°/app/ç›®å½•
RUN pip install flask   # ç¬¬5å±‚ï¼šåœ¨ç¬¬4å±‚åŸºç¡€ä¸Šå®‰è£…flaskï¼Œè®°å½•æ‰€æœ‰å˜åŒ–çš„æ–‡ä»¶
```
ç®€å•è¯´ï¼šé•œåƒ = è“å›¾/æ¨¡æ¿ï¼ˆé™æ€ï¼Œä¸èƒ½åŠ¨ï¼‰ï¼Œå®¹å™¨ = å®é™…è¿è¡Œçš„è¿›ç¨‹ï¼ˆåŠ¨æ€ï¼Œèƒ½åŠ¨ï¼‰ï¼Œé•œåƒä¸è¿è¡Œï¼Œæ˜¯å› ä¸ºå®ƒç¼ºå°‘â€œæ‰§è¡Œä¸Šä¸‹æ–‡â€ï¼ˆå¦‚å†…å­˜ã€CPUã€ç½‘ç»œï¼‰ï¼Œå®¹å™¨æä¾›äº†è¿™ä¸ªä¸Šä¸‹æ–‡ã€‚


**è¡¨æ ¼æ€»ç»“**ï¼šDocker æ ¸å¿ƒæ¦‚å¿µ

| æ¦‚å¿µ             | æè¿°                            | ç¤ºä¾‹å‘½ä»¤/ç”¨é€”                      |
| -------------- | ----------------------------- | ---------------------------- |
| Dockerfile     | æ„å»ºé•œåƒçš„è“å›¾æ–‡ä»¶ã€‚                    | è§ä»£ç ç¤ºä¾‹                        |
| é•œåƒ (Image)     | åªè¯»æ¨¡æ¿ï¼ŒåŒ…å«åº”ç”¨ä»£ç ã€è¿è¡Œæ—¶ã€åº“ç­‰ã€‚åƒè½¯ä»¶çš„â€œå®‰è£…åŒ…â€ã€‚ | `docker pull nginx`          |
| å®¹å™¨ (Container) | é•œåƒçš„è¿è¡Œå®ä¾‹ï¼Œè½»é‡çº§ã€å¯éš”ç¦»çš„è¿›ç¨‹ã€‚åƒâ€œè¿è¡Œä¸­çš„è½¯ä»¶â€ã€‚ | `docker run -d nginx`        |
| ä»“åº“ (Registry)  | å­˜å‚¨é•œåƒçš„åœ°æ–¹ï¼Œå¦‚ Docker Hubã€‚         | `docker push myimage:latest` |
```text
èœè°±ï¼ˆDockerfileï¼‰ â†’ åšèœï¼ˆæ„å»ºé•œåƒï¼‰ â†’ ä»“åº“å­˜å‚¨ï¼ˆRegistryï¼‰ â†’ ç«¯èœä¸Šæ¡Œï¼ˆè¿è¡Œå®¹å™¨ï¼‰
```
é•œåƒå°±åƒä¸€ä¸ªâ€œå†»å¥½çš„åŠæˆå“èœâ€ï¼ˆæ¯”å¦‚è¶…å¸‚ä¹°çš„å†·å†»æŠ«è¨ï¼‰ï¼Œå®ƒåŒ…å«äº†æ‰€æœ‰ææ–™å’Œé…æ–¹ï¼Œä½†å®ƒæœ¬èº«æ˜¯é™æ€çš„ã€ä¸å¯å˜çš„ï¼Œä¸èƒ½ç›´æ¥â€œåƒâ€ï¼ˆè¿è¡Œï¼‰ã€‚ä½ éœ€è¦æŠŠå®ƒæ”¾è¿›çƒ¤ç®±åŠ çƒ­ï¼ˆå®¹å™¨ï¼‰ï¼Œæ‰èƒ½å˜æˆçƒ­è…¾è…¾çš„å¯é£Ÿç”¨çŠ¶æ€ã€‚ä¸ºä»€ä¹ˆä¸ç›´æ¥è¿è¡Œé•œåƒï¼Ÿå› ä¸ºé•œåƒè®¾è®¡æˆâ€œåªè¯»æ¨¡æ¿â€ï¼Œç›®çš„æ˜¯ä¸ºäº†å®‰å…¨ã€å¯é‡å¤æ€§å’Œæ•ˆç‡â€”â€”å®ƒä¸ä¼šè¢«ä¿®æ”¹ï¼Œç¡®ä¿æ¯æ¬¡ä½¿ç”¨éƒ½ä¸€è‡´ã€‚ä½†è¿è¡Œæ—¶éœ€è¦ä¸€ä¸ªåŠ¨æ€çš„ç¯å¢ƒæ¥æ‰§è¡Œä»£ç ã€åˆ†é…èµ„æºã€å¤„ç†è¾“å…¥è¾“å‡ºï¼Œè¿™å°±æ˜¯å®¹å™¨çš„ä½œç”¨ã€‚å®¹å™¨æ˜¯é•œåƒçš„â€œæ´»ä½“æ‹·è´â€ï¼Œæä¾›éš”ç¦»ï¼ˆåƒæ²™ç®±ï¼‰ï¼Œé˜²æ­¢ä¸€ä¸ªåº”ç”¨å¹²æ‰°å¦ä¸€ä¸ªã€‚

ç®€å•è¯´ï¼š**é•œåƒ = è“å›¾/æ¨¡æ¿ï¼ˆé™æ€ï¼Œä¸èƒ½åŠ¨ï¼‰**ï¼Œ**å®¹å™¨ = å®é™…è¿è¡Œçš„è¿›ç¨‹ï¼ˆåŠ¨æ€ï¼Œèƒ½åŠ¨ï¼‰**ã€‚é•œåƒä¸è¿è¡Œï¼Œæ˜¯å› ä¸ºå®ƒç¼ºå°‘â€œæ‰§è¡Œä¸Šä¸‹æ–‡â€ï¼ˆå¦‚å†…å­˜ã€CPUã€ç½‘ç»œï¼‰ï¼Œå®¹å™¨æä¾›äº†è¿™ä¸ªä¸Šä¸‹æ–‡ã€‚


**ä»£ç ç¤ºä¾‹**ï¼šç®€å•è¿è¡Œä¸€ä¸ªå®¹å™¨
```bash
# æ‹‰å–é•œåƒ
docker pull hello-world

# è¿è¡Œå®¹å™¨ï¼ˆ-it: äº¤äº’æ¨¡å¼ï¼‰
docker run -it hello-world

# æŸ¥çœ‹è¿è¡Œä¸­å®¹å™¨
docker ps

# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨ï¼ˆåŒ…æ‹¬åœæ­¢çš„ï¼‰
docker ps -a
```

**å­¦ä¹ èµ„æºé“¾æ¥**ï¼š
- å®˜æ–¹ Docker å…¥é—¨ï¼šhttps://docs.docker.com/get-started/
- Docker Hubï¼šhttps://hub.docker.com/ (æœç´¢é•œåƒ)

---

#### æ¨¡å— 2: æ„å»ºå’Œè‡ªå®šä¹‰é•œåƒ
**æ–‡å­—è§£é‡Š**ï¼šä» Dockerfile å¼€å§‹æ„å»ºè‡ªå®šä¹‰é•œåƒï¼Œè¿™æ˜¯è¿›é˜¶çš„å…³é”®ã€‚å­¦ä¼šç¼–å†™ Dockerfileï¼Œèƒ½è®©ä½ çš„ DataCody Agent åœ¨å®¹å™¨ä¸­æ— ç¼è¿è¡Œæ•°æ®ç¼–è¯‘é€»è¾‘ï¼Œé¿å…ä¾èµ–å†²çªã€‚

**è¡¨æ ¼æ€»ç»“**ï¼šDockerfile å¸¸ç”¨æŒ‡ä»¤

| æŒ‡ä»¤       | æè¿°                                                                 | ç¤ºä¾‹                           |
|------------|----------------------------------------------------------------------|--------------------------------|
| FROM      | æŒ‡å®šåŸºç¡€é•œåƒ                                                         | `FROM python:3.9-slim`        |
| RUN       | åœ¨é•œåƒä¸­æ‰§è¡Œå‘½ä»¤ï¼ˆe.g., å®‰è£…åŒ…ï¼‰                                     | `RUN pip install flask`       |
| COPY      | å¤åˆ¶æœ¬åœ°æ–‡ä»¶åˆ°é•œåƒ                                                   | `COPY app.py /app/`           |
| CMD       | å®¹å™¨å¯åŠ¨æ—¶é»˜è®¤æ‰§è¡Œçš„å‘½ä»¤                                             | `CMD ["python", "app.py"]`    |
| ENTRYPOINT| å®¹å™¨å¯åŠ¨æ—¶å›ºå®šæ‰§è¡Œçš„å‘½ä»¤ï¼ˆå¯è¦†ç›– CMDï¼‰                               | `ENTRYPOINT ["python"]`       |
| EXPOSE    | æš´éœ²ç«¯å£ï¼ˆä¸å®é™…æ‰“å¼€ï¼Œä»…æ–‡æ¡£åŒ–ï¼‰                                     | `EXPOSE 5000`                 |

**ä»£ç ç¤ºä¾‹**ï¼šä¸º DataCody é¡¹ç›®æ„å»ºä¸€ä¸ªç®€å• Flask åº”ç”¨é•œåƒ
1. åˆ›å»º `app.py`ï¼š
```python
from flask import Flask
app = Flask(__name__)

@app.route('/')
def hello():
    return "DataCody Agent: Data Workflow Compiled!"

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
```


2. åˆ›å»º `Dockerfile`ï¼š
```dockerfile
FROM python:3.12-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY app.py .
EXPOSE 5000
CMD ["python", "app.py"]
```

3. æ„å»ºå’Œè¿è¡Œï¼š
```bash
# å‡è®¾ requirements.txt æœ‰ flask
echo "flask" > requirements.txt

# æ„å»ºé•œåƒï¼ˆtag ä¸º my-datacody:v1ï¼‰
docker build -t my-datacody:v1 .

# è¿è¡Œå®¹å™¨ï¼ˆ-p: ç«¯å£æ˜ å°„ï¼‰
docker run -d -p 5000:5000 my-datacody:v1

# æµ‹è¯•ï¼šæµè§ˆå™¨è®¿é—® localhost:5000
```

Docker å°†åˆ›å»ºå’Œç®¡ç†è¿™äº›ä¸Šä¸‹æ–‡ç¯å¢ƒçš„å¤æ‚å·¥ä½œå®Œå…¨å°è£…åœ¨äº† **docker run** å‘½ä»¤å†…éƒ¨ï¼Œé‚£ä¹ˆï¼Œå¦‚ä½•éªŒè¯è¿™äº›ä¸Šä¸‹æ–‡ç¯å¢ƒçš„åˆ›å»ºï¼Ÿ
```python
# æŸ¥çœ‹è¿è¡Œä¸­çš„å®¹å™¨åŠå…¶ç½‘ç»œä¸Šä¸‹æ–‡
docker ps
# æ¯ä¸ªå®¹å™¨éƒ½æœ‰è‡ªå·±çš„ç½‘ç»œå‘½åç©ºé—´ï¼Œå¯ä»¥çœ‹åˆ°ä¸åŒçš„ç«¯å£æ˜ å°„

# æŸ¥çœ‹å®¹å™¨çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç½‘ç»œå’Œæ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡
docker inspect app1
# è¾“å‡ºä¸­åŒ…å«ï¼š
# "NetworkSettings": { ... }  # ç½‘ç»œä¸Šä¸‹æ–‡
# "Mounts": [...]             # æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ä¿¡æ¯
# "State": { ... }          # è¿›ç¨‹å’Œèµ„æºä½¿ç”¨çŠ¶æ€

# åœ¨å®¹å™¨å†…éƒ¨éªŒè¯éš”ç¦»çš„ä¸Šä¸‹æ–‡ç¯å¢ƒ
docker exec -it app1 ps aux    # åªçœ‹åˆ°å®¹å™¨å†…çš„è¿›ç¨‹
docker exec -it app1 ip addr  # åªçœ‹åˆ°å®¹å™¨è‡ªå·±çš„ç½‘ç»œæ¥å£å’ŒIPåœ°å€
```

**å­¦ä¹ èµ„æºé“¾æ¥**ï¼š
- Dockerfile å‚è€ƒï¼šhttps://docs.docker.com/reference/dockerfile/
- æœ€ä½³å®è·µï¼šhttps://docs.docker.com/develop/develop-images/dockerfile_best-practices/

---

#### æ¨¡å— 3: å®¹å™¨ç®¡ç†ä¸ç”Ÿå‘½å‘¨æœŸ
**æ–‡å­—è§£é‡Š**ï¼šæŒæ¡å®¹å™¨çš„å¯åŠ¨ã€åœæ­¢ã€æ£€æŸ¥å’Œåˆ é™¤ã€‚è¿›é˜¶åˆ° DevOps æ—¶ï¼Œè¿™å¸®åŠ©ä½ è‡ªåŠ¨åŒ–éƒ¨ç½² DataCody çš„å¤šå®ä¾‹è¿è¡Œã€‚

**è¡¨æ ¼æ€»ç»“**ï¼šå®¹å™¨ç®¡ç†å‘½ä»¤

| å‘½ä»¤       | æè¿°                                                                 | ç¤ºä¾‹                           |
|------------|----------------------------------------------------------------------|--------------------------------|
| docker run | åˆ›å»ºå¹¶å¯åŠ¨å®¹å™¨                                                       | `docker run -d --name myapp nginx` |
| docker start/stop | å¯åŠ¨/åœæ­¢å®¹å™¨                                                        | `docker stop myapp`           |
| docker exec | åœ¨è¿è¡Œå®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤                                                 | `docker exec -it myapp bash`  |
| docker logs | æŸ¥çœ‹å®¹å™¨æ—¥å¿—                                                         | `docker logs myapp`           |
| docker rm  | åˆ é™¤å®¹å™¨                                                             | `docker rm myapp`             |
| docker inspect | æŸ¥çœ‹å®¹å™¨è¯¦æƒ…ï¼ˆJSONï¼‰                                                 | `docker inspect myapp`        |

**ä»£ç ç¤ºä¾‹**ï¼šç®¡ç† DataCody å®¹å™¨
```bash
# è¿è¡Œå¹¶å‘½åå®¹å™¨
docker run -d --name datacody-agent -p 5000:5000 my-datacody:v1

# è¿›å…¥å®¹å™¨ shell
docker exec -it datacody-agent /bin/bash

# æŸ¥çœ‹æ—¥å¿—ï¼ˆ-f: è·Ÿéšï¼‰
docker logs -f datacody-agent

# åœæ­¢å¹¶åˆ é™¤
docker stop datacody-agent
docker rm datacody-agent
```

**å­¦ä¹ èµ„æºé“¾æ¥**ï¼š
- å®¹å™¨å‘½ä»¤å‚è€ƒï¼šhttps://docs.docker.com/reference/cli/docker/container/
- Docker CLI æ•™ç¨‹ï¼šhttps://www.digitalocean.com/community/tutorials/how-to-remove-docker-images-containers-and-volumes

---

#### æ¨¡å— 4: Docker Compose - å¤šå®¹å™¨ orchestration
**æ–‡å­—è§£é‡Š**ï¼šå¯¹äºå¤æ‚åº”ç”¨å¦‚ DataCodyï¼ˆå¯èƒ½æ¶‰åŠæ•°æ®åº“ã€APIã€workerï¼‰ï¼Œä½¿ç”¨ Docker Compose å®šä¹‰å¤šå®¹å™¨ç¯å¢ƒã€‚è¿™æ˜¯ä»å•å®¹å™¨åˆ° DevOps çš„æ¡¥æ¢ã€‚

**è¡¨æ ¼æ€»ç»“**ï¼šdocker-compose.yml å…³é”®å­—æ®µ

| å­—æ®µ       | æè¿°                                                                 | ç¤ºä¾‹                           |
|------------|----------------------------------------------------------------------|--------------------------------|
| services  | å®šä¹‰æœåŠ¡ï¼ˆå®¹å™¨ï¼‰                                                     | `app: build: .`               |
| build     | æŒ‡å®šæ„å»ºè·¯å¾„æˆ– Dockerfile                                             | `build: .`                    |
| ports     | ç«¯å£æ˜ å°„                                                             | `ports: - "5000:5000"`        |
| volumes   | æ•°æ®æŒä¹…åŒ–                                                           | `volumes: - ./data:/app/data` |
| depends_on| æœåŠ¡ä¾èµ–é¡ºåº                                                         | `depends_on: - db`            |
| networks  | è‡ªå®šä¹‰ç½‘ç»œ                                                           | `networks: - mynet`           |

**ä»£ç ç¤ºä¾‹**ï¼šä¸º DataCody æ·»åŠ  PostgreSQL æ•°æ®åº“
1. åˆ›å»º `docker-compose.yml`ï¼š
```yaml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "5000:5000"
    depends_on:
      - db
    environment:
      - DB_URL=postgres://user:pass@db:5432/datacody

  db:
    image: postgres:16
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
      - POSTGRES_DB=datacody
    volumes:
      - db-data:/var/lib/postgresql/data

volumes:
  db-data:
```

2. è¿è¡Œï¼š
```bash
# å¯åŠ¨ï¼ˆ-d: åå°ï¼‰
docker compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker compose logs app

# åœæ­¢
docker compose down
```

**å­¦ä¹ èµ„æºé“¾æ¥**ï¼š
- å®˜æ–¹ Compose æ–‡æ¡£ï¼šhttps://docs.docker.com/compose/
- ç¤ºä¾‹é¡¹ç›®ï¼šhttps://github.com/docker/awesome-compose

---

#### æ¨¡å— 5: å®¹å™¨ç½‘ç»œ - å…‹æœæ£˜æ‰‹éš¾é¢˜
**æ–‡å­—è§£é‡Š**ï¼šç½‘ç»œæ˜¯ Docker ç—›ç‚¹ä¹‹ä¸€ï¼šå®¹å™¨é—´é€šä¿¡ã€ç«¯å£å†²çªã€å¤–éƒ¨è®¿é—®ã€‚DevOps æ€ç»´å¼ºè°ƒéš”ç¦»ä¸è¿é€šæ€§ã€‚åœ¨ DataCody ä¸­ï¼Œç¡®ä¿æ•°æ®å·¥ä½œæµå®¹å™¨èƒ½å®‰å…¨é€šä¿¡ï¼ˆå¦‚ API åˆ° DBï¼‰ã€‚

**è¡¨æ ¼æ€»ç»“**ï¼šDocker ç½‘ç»œç±»å‹

| ç±»å‹       | æè¿°                                                                 | ç”¨ä¾‹                           | å‘½ä»¤ç¤ºä¾‹                       |
|------------|----------------------------------------------------------------------|--------------------------------|--------------------------------|
| bridge (é»˜è®¤) | å†…éƒ¨ç½‘ç»œï¼Œå®¹å™¨é—´ç”¨æœåŠ¡åé€šä¿¡                                         | æœ¬åœ°å¼€å‘                       | `docker network create mynet` |
| host      | å®¹å™¨å…±äº«ä¸»æœºç½‘ç»œï¼ˆæ— éš”ç¦»ï¼‰                                           | é«˜æ€§èƒ½éœ€æ±‚                     | `--network host`              |
| overlay   | å¤šä¸»æœºç½‘ç»œï¼ˆSwarm æ¨¡å¼ï¼‰                                             | åˆ†å¸ƒå¼éƒ¨ç½²                     | `docker network create -d overlay myoverlay` |
| none      | æ— ç½‘ç»œ                                                               | éš”ç¦»æµ‹è¯•                       | `--network none`              |

**ä»£ç ç¤ºä¾‹**ï¼šè¯Šæ–­å’Œé…ç½®ç½‘ç»œ
```bash
# åˆ›å»ºè‡ªå®šä¹‰æ¡¥æ¥ç½‘ç»œ
docker network create my-datacody-net

# è¿è¡Œå®¹å™¨åˆ°ç½‘ç»œ
docker run -d --name app --network my-datacody-net my-datacody:v1
docker run -d --name db --network my-datacody-net postgres:16

# è¯Šæ–­ï¼šæ£€æŸ¥ç½‘ç»œ
docker network inspect my-datacody-net

# æµ‹è¯•é€šä¿¡ï¼šä» app ping db
docker exec -it app ping db

# å¸¸è§éš¾é¢˜è§£å†³ï¼šç«¯å£å†²çªï¼Ÿç”¨ `docker ps` æ£€æŸ¥å ç”¨ç«¯å£ï¼Œæ€è¿›ç¨‹æˆ–é‡æ˜ å°„ã€‚
# å¤–éƒ¨è®¿é—®å¤±è´¥ï¼Ÿç¡®ä¿é˜²ç«å¢™å…è®¸ï¼ˆe.g., ufw allow 5000ï¼‰ã€‚
```

**è¿›é˜¶è¯Šæ–­æŠ€å·§**ï¼š
- ç”¨ `docker logs` + `tcpdump` åœ¨å®¹å™¨å†…æ•è·åŒ…ï¼š`docker exec -it app apt install tcpdump -y; tcpdump -i eth0`.
- å¤šä¸»æœºï¼šå¯ç”¨ Swarm `docker swarm init`ï¼Œç”¨ overlay ç½‘ç»œã€‚

**å­¦ä¹ èµ„æºé“¾æ¥**ï¼š
- å®˜æ–¹ç½‘ç»œæ–‡æ¡£ï¼šhttps://docs.docker.com/network/
- ç½‘ç»œæ•…éšœæ’é™¤ï¼šhttps://www.digitalocean.com/community/tutorials/how-to-troubleshoot-common-docker-networking-issues

---

#### æ¨¡å— 6: æ—¥å¿—ç®¡ç†ä¸è¯Šæ–­ - å…‹æœæ£˜æ‰‹éš¾é¢˜
**æ–‡å­—è§£é‡Š**ï¼šæ—¥å¿—è¯Šæ–­æ˜¯å¦ä¸€ä¸ªéš¾é¢˜ï¼šå®¹å™¨æ—¥å¿—åˆ†æ•£ã€ä¸¢å¤±ã€è¿‡è½½ã€‚åœ¨ DevOps ä¸­ï¼Œé›†æˆæ—¥å¿—å·¥å…·å¦‚ ELK æ ˆæ˜¯å…³é”®ã€‚å¯¹äº DataCodyï¼Œæ—¥å¿—å¸®åŠ©è°ƒè¯•æ•°æ®å·¥ä½œæµé”™è¯¯ã€‚

**è¡¨æ ¼æ€»ç»“**ï¼šæ—¥å¿—é©±åŠ¨ç¨‹åº

| é©±åŠ¨       | æè¿°                                                                 | é…ç½®ç¤ºä¾‹                       |
|------------|----------------------------------------------------------------------|--------------------------------|
| json-file (é»˜è®¤) | æœ¬åœ° JSON æ–‡ä»¶                                                       | `--log-driver json-file`      |
| syslog    | å‘é€åˆ°ç³»ç»Ÿæ—¥å¿—                                                       | `--log-driver syslog`         |
| fluentd   | å‘é€åˆ° Fluentdï¼ˆèšåˆï¼‰                                               | `--log-driver fluentd`        |
| journald  | ç³»ç»Ÿ journald                                                        | `--log-driver journald`       |

**ä»£ç ç¤ºä¾‹**ï¼šé…ç½®å’Œè¯Šæ–­æ—¥å¿—
```bash
# è¿è¡Œå®¹å™¨å¸¦æ—¥å¿—é€‰é¡¹ï¼ˆmax-size é™åˆ¶å¤§å°ï¼‰
docker run -d --name app --log-driver json-file --log-opt max-size=10m my-datacody:v1

# æŸ¥çœ‹æ—¥å¿—ï¼ˆ--tail æœ€å N è¡Œï¼‰
docker logs --tail 50 app

# è·Ÿéšæ—¥å¿— + æ—¶é—´æˆ³
docker logs -f -t app

# è¿›é˜¶ï¼šç”¨ Docker Compose é…ç½® fluentd
# æ·»åŠ æœåŠ¡åˆ° ymlï¼š
fluentd:
  image: fluent/fluentd
  ports:
    - "24224:24224"

# åœ¨ app æœåŠ¡ï¼šlogging: driver: fluentd

# è¯Šæ–­éš¾é¢˜ï¼šæ—¥å¿—ä¸¢å¤±ï¼Ÿæ£€æŸ¥ `docker inspect app | grep LogPath` è·¯å¾„ã€‚
# è¿‡è½½ï¼Ÿç”¨ `--log-opt max-file=3` è½®è½¬æ–‡ä»¶ã€‚
```

**DevOps é›†æˆ**ï¼šç”¨ ELK (Elasticsearch, Logstash, Kibana) èšåˆæ—¥å¿—ã€‚è¿è¡Œ ELK æ ˆä½œä¸º Compose æœåŠ¡ã€‚

**å­¦ä¹ èµ„æºé“¾æ¥**ï¼š
- å®˜æ–¹æ—¥å¿—æ–‡æ¡£ï¼šhttps://docs.docker.com/config/containers/logging/
- ELK ä¸ Dockerï¼šhttps://www.elastic.co/guide/en/beats/filebeat/current/running-on-docker.html

---

#### æ¨¡å— 7: å·ä¸å­˜å‚¨ - æ•°æ®æŒä¹…åŒ–
**æ–‡å­—è§£é‡Š**ï¼šå®¹å™¨æ˜¯çŸ­æš‚çš„ï¼Œå·ç¡®ä¿æ•°æ®æŒä¹…ã€‚åœ¨ DataCody ä¸­ï¼Œç”¨äºå­˜å‚¨ç¼–è¯‘åçš„å·¥ä½œæµæ•°æ®ã€‚

**è¡¨æ ¼æ€»ç»“**ï¼šå·ç±»å‹

| ç±»å‹       | æè¿°                                                                 | ç¤ºä¾‹                           |
|------------|----------------------------------------------------------------------|--------------------------------|
| ç»‘å®šæŒ‚è½½   | ä¸»æœºç›®å½•åˆ°å®¹å™¨                                                       | `-v /host/path:/container/path` |
| å‘½åå·     | Docker ç®¡ç†å·                                                        | `-v myvolume:/data`           |
| tmpfs     | å†…å­˜å·ï¼ˆä¸´æ—¶ï¼‰                                                       | `--tmpfs /tmp`                |

**ä»£ç ç¤ºä¾‹**ï¼š
```bash
# åˆ›å»ºå·
docker volume create datacody-data

# è¿è¡Œå¸¦å·
docker run -d -v datacody-data:/app/data my-datacody:v1

# æ£€æŸ¥å·
docker volume inspect datacody-data
```

**å­¦ä¹ èµ„æºé“¾æ¥**ï¼š
- å®˜æ–¹å­˜å‚¨æ–‡æ¡£ï¼šhttps://docs.docker.com/storage/

---

#### æ¨¡å— 8: å®‰å…¨æœ€ä½³å®è·µ
**æ–‡å­—è§£é‡Š**ï¼šDevOps å¼ºè°ƒå®‰å…¨ï¼šæœ€å°æƒé™ã€æ‰«ææ¼æ´ã€‚åœ¨ DataCody ä¸­ï¼Œä¿æŠ¤æ•°æ®å¤„ç†é€»è¾‘ã€‚

**è¡¨æ ¼æ€»ç»“**ï¼šå®‰å…¨æ£€æŸ¥ç‚¹

| å®è·µ       | æè¿°                                                                 |
|------------|----------------------------------------------------------------------|
| é root ç”¨æˆ· | åœ¨ Dockerfile ç”¨ `USER appuser`                                      |
| æ‰«æé•œåƒ     | ç”¨ Trivy æˆ– Clair                                                    |
| ç§˜å¯†ç®¡ç†     | ç”¨ Docker Secrets æˆ–ç¯å¢ƒå˜é‡                                         |
| ç½‘ç»œéš”ç¦»     | ç”¨è‡ªå®šä¹‰ç½‘ç»œ + firewall                                              |

**ä»£ç ç¤ºä¾‹**ï¼š
```dockerfile
# Dockerfile æ·»åŠ ç”¨æˆ·
RUN useradd -m appuser
USER appuser
```

**å­¦ä¹ èµ„æºé“¾æ¥**ï¼š
- å®˜æ–¹å®‰å…¨ï¼šhttps://docs.docker.com/engine/security/
- Trivy å·¥å…·ï¼šhttps://aquasecurity.github.io/trivy/

---

#### æ¨¡å— 9: éƒ¨ç½²åˆ°ç”Ÿäº§ä¸ CI/CD
**æ–‡å­—è§£é‡Š**ï¼šä»æœ¬åœ°åˆ°äº‘ï¼ˆå¦‚ AWS ECSã€Kubernetesï¼‰ã€‚é›†æˆ GitHub Actions ä¸º DataCody è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚

**ä»£ç ç¤ºä¾‹**ï¼šç®€å• GitHub Actions workflow
```yaml
name: Deploy to Docker Hub
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          push: true
          tags: yourusername/datacody:latest
```

**å­¦ä¹ èµ„æºé“¾æ¥**ï¼š
- Docker Swarm/K8sï¼šhttps://docs.docker.com/engine/swarm/
- CI/CD æ•™ç¨‹ï¼šhttps://docs.github.com/en/actions/guides/building-and-testing-python (é€‚åº” Docker)

---

#### æ¨¡å— 10: é«˜çº§ä¸»é¢˜ä¸æ•…éšœæ’é™¤
**æ–‡å­—è§£é‡Š**ï¼šä¼˜åŒ–ï¼ˆå¦‚èµ„æºé™åˆ¶ï¼‰ã€ç›‘æ§ï¼ˆPrometheusï¼‰ã€‚å¸¸è§é—®é¢˜ï¼šå†…å­˜æº¢å‡ºï¼Ÿç”¨ `--memory=512m`ã€‚

**è¡¨æ ¼æ€»ç»“**ï¼šå¸¸è§æ•…éšœ

| é—®é¢˜       | è§£å†³æ–¹æ¡ˆ                                                             |
|------------|----------------------------------------------------------------------|
| ç½‘ç»œä¸é€š   | æ£€æŸ¥ `docker network inspect`ï¼Œç¡®ä¿æœåŠ¡åè§£æ                         |
| æ—¥å¿—ä¸¢å¤±   | é…ç½®æŒä¹…å· + å¤–éƒ¨èšåˆ                                                |
| é•œåƒå¤ªå¤§   | ç”¨å¤šé˜¶æ®µæ„å»ºï¼ˆmulti-stageï¼‰                                          |
| æƒé™é”™è¯¯   | ç”¨ `chown` è°ƒæ•´ä¸»æœºæ–‡ä»¶æƒé™                                          |

**ä»£ç ç¤ºä¾‹**ï¼šå¤šé˜¶æ®µæ„å»º
```dockerfile
FROM python:3.12 AS builder
# æ„å»ºé˜¶æ®µ...

FROM python:3.12-slim
COPY --from=builder /app /app
```

**å­¦ä¹ èµ„æºé“¾æ¥**ï¼š
- é«˜çº§æ•™ç¨‹ï¼šhttps://docs.docker.com/develop/
- æ•…éšœæ’é™¤ï¼šhttps://docs.docker.com/config/troubleshooting/

---

è¿™ä»½æŒ‡å—ä»åŸºç¡€åˆ°é«˜çº§ï¼Œè¦†ç›–äº† Docker éƒ¨ç½²çš„å…¨é“¾è·¯ã€‚ä½ å¯ä»¥ç›´æ¥å¤åˆ¶ä»£ç æ‰§è¡Œï¼Œé€æ­¥æ„å»ºä½ çš„ DataCody é¡¹ç›®ã€‚å¦‚æœé‡åˆ°é—®é¢˜ï¼Œä¼˜å…ˆç”¨ `docker --help` æˆ–èµ„æºé“¾æ¥ã€‚æœªæ¥æ‰©å±•åˆ° Kubernetes æ—¶ï¼Œè¿™å°†æ˜¯åšå®åŸºç¡€ï¼å¦‚æœéœ€è¦ç‰¹å®šéƒ¨åˆ†æ‰©å±•ï¼Œå‘Šè¯‰æˆ‘ã€‚

## å­¦ä¹ èµ„æº

### å®˜æ–¹æ–‡æ¡£
- [Docker å®˜æ–¹æ–‡æ¡£](https://docs.docker.com/)
- [Dockerfile æœ€ä½³å®è·µ](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/)
- [Docker Compose æ–‡æ¡£](https://docs.docker.com/compose/)

### å®è·µæ•™ç¨‹
- [Docker å…¥é—¨åˆ°å®è·µ](https://github.com/yeasy/docker_practice)
- [Docker & Kubernetes å®æˆ˜](https://kubernetes.io/docs/tutorials/)
- [Docker å®‰å…¨æœ€ä½³å®è·µ](https://docs.docker.com/engine/security/)

### è§†é¢‘è¯¾ç¨‹
- [Docker Mastery](https://www.udemy.com/course/docker-mastery/) - Udemy
- [Docker æ·±å…¥æµ…å‡º](https://www.bilibili.com/video/BV1og4y1q7M4) - Bç«™

### å·¥å…·æ¨è
- [Dive](https://github.com/wagoodman/dive) - é•œåƒåˆ†æå·¥å…·
- [Trivy](https://github.com/aquasecurity/trivy) - å®‰å…¨æ‰«æ
- [Lens](https://k8slens.dev/) - Kubernetes IDE
- [Portainer](https://www.portainer.io/) - å®¹å™¨ç®¡ç†UI

### ç¤¾åŒºèµ„æº
- [Docker å®˜æ–¹åšå®¢](https://www.docker.com/blog/)
- [Docker ç¤¾åŒºè®ºå›](https://forums.docker.com/)
- [Stack Overflow Docker æ ‡ç­¾](https://stackoverflow.com/questions/tagged/docker)

---

## æ€»ç»“

é€šè¿‡æœ¬æŒ‡å—ï¼Œæ‚¨å·²ç»ç³»ç»ŸæŒæ¡äº†ï¼š

1. **Docker æ ¸å¿ƒæ¦‚å¿µ** - ç†è§£æ¶æ„å’Œç»„ä»¶å…³ç³»
2. **Dockerfile æœ€ä½³å®è·µ** - ç¼–å†™é«˜æ•ˆå®‰å…¨çš„é•œåƒ
3. **ç½‘ç»œæ·±åº¦æŒæ¡** - è§£å†³å¤æ‚å®¹å™¨é€šä¿¡é—®é¢˜
4. **å­˜å‚¨ç®¡ç†** - æ•°æ®æŒä¹…åŒ–å’Œå¤‡ä»½ç­–ç•¥
5. **æ—¥å¿—ç›‘æ§** - å®Œæ•´çš„å¯è§‚æµ‹æ€§æ–¹æ¡ˆ
6. **ç”Ÿäº§éƒ¨ç½²** - å®‰å…¨ã€å¯é çš„ç”Ÿäº§ç¯å¢ƒé…ç½®

å¯¹äº DataCody Agent é¡¹ç›®ï¼Œæ‚¨ç°åœ¨å¯ä»¥ï¼š

- âœ… è®¾è®¡å¤šæœåŠ¡å®¹å™¨åŒ–æ¶æ„
- âœ… å®ç°å¼€å‘/ç”Ÿäº§ç¯å¢ƒä¸€è‡´æ€§
- âœ… å»ºç«‹å®Œæ•´çš„ç›‘æ§å‘Šè­¦ä½“ç³»
- âœ… å®æ–½è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹
- âœ… ç¡®ä¿æ•°æ®å®‰å…¨å’ŒæŒä¹…åŒ–

**ä¸‹ä¸€æ­¥å»ºè®®**ï¼šåœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨è¿™äº›çŸ¥è¯†ï¼Œä»ç®€å•çš„å•æœåŠ¡å¼€å§‹ï¼Œé€æ­¥æ‰©å±•åˆ°å¤æ‚çš„å¾®æœåŠ¡æ¶æ„ï¼ŒæŒç»­ä¼˜åŒ–éƒ¨ç½²æµç¨‹å’Œç›‘æ§ä½“ç³»ã€‚
